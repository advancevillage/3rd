name: tests

on:
  push:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-24.04
    services:
       mysql:
        image: mysql:8.0
        env:
          MYSQL_DATABASE: test
          MYSQL_ROOT_PASSWORD: password
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3 
    steps:
    - uses: actions/checkout@v2

    - name: init-mysql-data
      run: |
        mysql -h 127.0.0.1 -P 3306 -u root -ppassword << EOF
        create database if not exists  test default charset utf8;
        create user 'test'@'%' identified by 'password';
        grant  all on test.* to 'test'@'%';
        flush privileges;
        use test;

        create table if not exists t_test_user (
          id int auto_increment,
          name char(64) not null default '' comment '名称',                                                
          age  int not null default 0 comment '年龄',
          createTime int(64) not null default 0 comment '创建时间',                                      
          updateTime int(64) not null default 0 comment '更新时间',
          deleteTime int(64) not null default 0 comment '删除时间',                                    - name: go-version
          primary key (`id`)                                                                             uses: actions/setup-go@v2
        )engine=innodb auto_increment=0 default charset utf8;                                              with:
                                                              
       create table if not exists t_test_class (                                                        - name: mathx
           cid int auto_increment,                                                                        run: go test -v -count=1 -cover ./mathx/
           uid int not null default 0 comment '用户id',
           name char(64) not null default '' comment '名称',                                            - name: netx
           teacher  char(64) not null default '' comment '教师',                                          run: go test -v -count=1 -cover ./netx/
           createTime int(64) not null default 0 comment '创建时间',
           updateTime int(64) not null default 0 comment '更新时间',                                    - name: radix
           deleteTime int(64) not null default 0 comment '删除时间',                                      run: go test -v -count=1 -cover ./radix/
           primary key (`cid`)
       )engine=innodb auto_increment=0 default charset utf8;                                            - name: cli cky
       EOF

    - name: go-version
      uses: actions/setup-go@v2
      with:
        go-version: 1.22

    - name: mathx
      run: go test -v -count=1 -cover ./mathx/

    - name: netx
      run: go test -v -count=1 -cover ./netx/

    - name: radix
      run: go test -v -count=1 -cover ./radix/

    - name: cli cky
      run: go build -o cli/cky/cky cli/cky/main.go

    - name: dht heap
      run: go test -v -count=1 -cover -test.run Test_dht_heap ./dht

    - name: sm3
      run: go test -v -count=1 -cover -test.run Test_sm3 ./cryptox/sm3

    - name: sm4
      run: go test -v -count=1 -cover -test.run Test_sm4 ./cryptox/sm4
    
    - name: sm4-2
      run: go test -bench='sm4$' -cpu=2,4  -benchtime=1s -count=3 ./cryptox/sm4

    - name: gf
      run: go test -v -count=1 -cover  ./mathx/gf/

    - name: bch
      run: go test -v -count=1 -cover ./mathx/bch/

    - name: rs
      run: go test -v -count=1 -cover ./mathx/rs/

    - name: dbx
      run: go test -v -count=1 -cover ./dbx/
